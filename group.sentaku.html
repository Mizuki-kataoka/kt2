<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>新規グループ登録</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <h1>➕ 新規グループ登録</h1>
    <p>授業名・グループ名・メンバーを入力して登録してください。</p>
  </header>

  <main>
    <form id="groupForm">
      <!-- 授業名 -->
      <label for="className">授業名:</label>
      <input type="text" id="className" name="className" required><br><br>

      <!-- グループ名 -->
      <label for="groupName">グループ名:</label>
      <input type="text" id="groupName" name="groupName" required><br><br>

      <!-- メンバー入力欄 -->
      <label>メンバー:</label><br>
      <div id="members-area">
        <input type="text" name="member" placeholder="メンバー1"><br>
        <input type="text" name="member" placeholder="メンバー2"><br>
        <input type="text" name="member" placeholder="メンバー3"><br>
      </div>
      <button type="button" id="addMemberBtn">＋ メンバー追加</button>
      <br><br>

      <!-- 貢献度（仮） -->
      <label for="contribution">貢献度:</label>
      <input type="number" id="contribution" name="contribution" value="0"><br><br>

      <!-- 登録ボタン -->
      <button type="submit">登録</button>
    </form>
  </main>

  <footer>
    <p style="margin-top: 50px;">&copy; 2025 あなたの頑張り見える化します</p>
  </footer>

  <!-- Firebase SDK & Firestore連携 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB2TFRxULrSZ9MWl-UkArF4bx22UXP3a-Q",
      authDomain: "isd-kt2.firebaseapp.com",
      projectId: "isd-kt2",
      storageBucket: "isd-kt2.appspot.com",
      messagingSenderId: "302204280336",
      appId: "1:302204280336:web:c9501e1a34618e9f46b495"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // メンバー欄を追加する処理
    const membersArea = document.getElementById("members-area");
    const addMemberBtn = document.getElementById("addMemberBtn");
    let memberCount = 3;

    addMemberBtn.addEventListener("click", () => {
      memberCount++;
      const input = document.createElement("input");
      input.type = "text";
      input.name = "member";
      input.placeholder = `メンバー${memberCount}`;
      membersArea.appendChild(input);
      membersArea.appendChild(document.createElement("br"));
    });

    // フォーム送信処理
    document.getElementById("groupForm").addEventListener("submit", async (event) => {
      event.preventDefault();

      const className = document.getElementById("className").value;
      const groupName = document.getElementById("groupName").value;
      const contribution = document.getElementById("contribution").value;

      // 複数メンバーを配列にまとめる
      const memberInputs = document.querySelectorAll("input[name='member']");
      const members = [];
      memberInputs.forEach(input => {
        if (input.value.trim() !== "") {
          members.push(input.value.trim());
        }
      });

      try {
        await addDoc(collection(db, "groups"), {
          className,
          groupName,
          members, // 配列として保存
          contribution: Number(contribution),
          createdAt: new Date()
        });
        alert("グループ登録が完了しました！");
        window.location.href = "mypage.html";
      } catch (e) {
        console.error("Error adding document: ", e);
        alert("登録に失敗しました。");
      }
    });

    function getUrlParameter(name) {
  const regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
  const results = regex.exec(location.search);
  return results === null ? "" : decodeURIComponent(results[1]);
}

const uid = getUrlParameter("uid");

await addDoc(collection(db, "groups"), {
  className,
  groupName,
  members,
  contribution: Number(contribution),
  createdAt: new Date(),
  userId: uid   // ← これを追加
});
  </script>
</body>
</html>

